# ビジュアルプログラミング＆ZIPダウンロード機能 実装計画

## 📋 概要

**目的**: Discord Bot作成の参入障壁を下げるため、Blockly型ビジュアルプログラミングエディタとZIPダウンロード機能を追加

**アプローチ**: 既存のフォームUIと共存させ、モード切り替え可能な段階的実装

---

## 🎯 実装方針

### 1. UI方式
- **Blockly型**: Scratch風のブロックエディタ（初心者に優しい）
- **共存**: フォームモードとビジュアルモードを切り替え可能
- **データ互換**: フォーム⇔ビジュアル間でデータ変換

### 2. 技術選定
- **Blockly本体**: `blockly` (Google公式)
- **React統合**: `react-blockly` または カスタムラッパー
- **ZIP生成**: `jszip` (ブラウザでZIP作成)
- **ファイルダウンロード**: `file-saver`

---

## 📦 フェーズ分け

### **フェーズ1: ZIPダウンロード機能**（優先度: 高）
**期間**: 2-3日
**範囲**: 既存機能の拡張のみ

#### 実装内容:
1. **依存関係追加**
   - `jszip`: ^3.10.1
   - `file-saver`: ^2.0.5
   - `@types/file-saver`: ^2.0.7

2. **新規ファイル**
   - `src/lib/zip-generator.ts`: ZIP生成ロジック

3. **修正ファイル**
   - `src/components/steps/Step4Review.tsx`: ダウンロードボタン追加
   - `src/app/api/generate/route.ts`: レスポンスにファイル情報追加

#### 機能詳細:
- GitHubにpush成功後、「ZIPでダウンロード」ボタンを表示
- 生成された全ファイルをZIPに圧縮してダウンロード
- ファイル名: `{bot-name}-{timestamp}.zip`

---

### **フェーズ2: Blocklyエディタ基盤**（優先度: 中）
**期間**: 1-2週間
**範囲**: ビジュアルエディタの基本機能

#### 実装内容:
1. **依存関係追加**
   - `blockly`: ^11.0.0
   - カスタムBlockly Reactラッパー作成

2. **新規ファイル**
   - `src/components/blockly/BlocklyEditor.tsx`: エディタコンポーネント
   - `src/components/blockly/blocks/`: カスタムブロック定義
     - `commandBlocks.ts`: コマンド関連ブロック
     - `optionBlocks.ts`: オプション関連ブロック
     - `responseBlocks.ts`: 応答関連ブロック
     - `apiBlocks.ts`: API呼び出しブロック
   - `src/lib/blockly-converter.ts`: ブロック⇔SlashCommand変換

3. **修正ファイル**
   - `src/components/steps/Step3Commands.tsx`: モード切り替えUI追加
   - `src/lib/types.ts`: VisualCommandFlow型追加

#### カスタムブロック設計:
```javascript
// コマンドブロック
{
  "type": "discord_command",
  "message0": "コマンド /%1 説明 %2",
  "args0": [
    { "type": "field_input", "name": "NAME" },
    { "type": "field_input", "name": "DESC" }
  ],
  "colour": 230,
  "nextStatement": "CommandFlow"
}

// オプションブロック
{
  "type": "command_option",
  "message0": "オプション %1 型 %2 必須 %3",
  "args0": [
    { "type": "field_input", "name": "NAME" },
    { "type": "field_dropdown", "name": "TYPE", "options": [
      ["文字列", "string"],
      ["整数", "integer"],
      ["真偽値", "boolean"]
    ]},
    { "type": "field_checkbox", "name": "REQUIRED" }
  ],
  "previousStatement": "CommandFlow",
  "nextStatement": "CommandFlow"
}

// API呼び出しブロック
{
  "type": "api_call",
  "message0": "API呼び出し %1 エンドポイント %2",
  "args0": [
    { "type": "field_dropdown", "name": "PROFILE" },
    { "type": "field_input", "name": "ENDPOINT" }
  ],
  "previousStatement": "CommandFlow",
  "nextStatement": "CommandFlow"
}
```

#### データ変換ロジック:
```typescript
// ブロック → SlashCommand
export function blocksToCommand(workspace: Blockly.Workspace): SlashCommand {
  const blocks = workspace.getTopBlocks();
  // XML → JSON → SlashCommand
}

// SlashCommand → ブロック
export function commandToBlocks(command: SlashCommand, workspace: Blockly.Workspace): void {
  // SlashCommand → JSON → XML
}
```

---

### **フェーズ3: 高度機能（条件分岐・ループ）**（優先度: 低）
**期間**: 2-3週間
**範囲**: 複雑なロジックの構築

#### 実装内容:
1. **新規ブロック**
   - `src/components/blockly/blocks/controlBlocks.ts`:
     - IF条件分岐ブロック
     - SWITCH分岐ブロック
     - FOR/WHILEループブロック
   - `src/components/blockly/blocks/logicBlocks.ts`:
     - 比較演算子ブロック
     - 論理演算子ブロック
     - 変数操作ブロック

2. **型定義拡張**
   - `src/lib/types.ts`:
     ```typescript
     // 新しい応答タイプ
     export enum ResponseType {
       STATIC_TEXT = 'static_text',
       API_CALL = 'api_call',
       VISUAL_FLOW = 'visual_flow', // 新規
     }

     // ビジュアルフロー型
     export interface VisualCommandFlow {
       blocks: BlocklyBlock[];
       connections: BlocklyConnection[];
     }

     export interface BlocklyBlock {
       id: string;
       type: 'command' | 'option' | 'api_call' | 'if' | 'loop' | 'response';
       config: Record<string, any>;
     }
     ```

3. **コード生成拡張**
   - `src/lib/template-generator.ts`: 条件分岐・ループのコード生成対応

#### 高度ブロック例:
```javascript
// IF条件分岐
{
  "type": "if_condition",
  "message0": "もし %1 なら",
  "args0": [
    { "type": "input_value", "name": "CONDITION" }
  ],
  "message1": "%1",
  "args1": [
    { "type": "input_statement", "name": "DO" }
  ],
  "message2": "そうでなければ %1",
  "args2": [
    { "type": "input_statement", "name": "ELSE" }
  ]
}
```

---

## 📁 ファイル構成

### 新規作成ファイル（23ファイル）

```
src/
├── lib/
│   ├── zip-generator.ts                    # フェーズ1
│   └── blockly-converter.ts                # フェーズ2
├── components/
│   └── blockly/
│       ├── BlocklyEditor.tsx               # フェーズ2
│       ├── BlocklyWorkspace.tsx            # フェーズ2
│       ├── ToolboxConfig.tsx               # フェーズ2
│       └── blocks/
│           ├── index.ts                    # フェーズ2
│           ├── commandBlocks.ts            # フェーズ2
│           ├── optionBlocks.ts             # フェーズ2
│           ├── responseBlocks.ts           # フェーズ2
│           ├── apiBlocks.ts                # フェーズ2
│           ├── controlBlocks.ts            # フェーズ3
│           └── logicBlocks.ts              # フェーズ3
docs/
└── ビジュアルプログラミング実装計画.md    # この計画書
```

### 修正ファイル（4ファイル）

```
src/
├── lib/
│   └── types.ts                            # 全フェーズ
├── components/steps/
│   ├── Step3Commands.tsx                   # フェーズ2
│   └── Step4Review.tsx                     # フェーズ1
└── app/api/generate/
    └── route.ts                            # フェーズ1
```

---

## 🔧 依存関係の追加

### package.json に追加

```json
{
  "dependencies": {
    "blockly": "^11.0.0",
    "jszip": "^3.10.1",
    "file-saver": "^2.0.5"
  },
  "devDependencies": {
    "@types/file-saver": "^2.0.7"
  }
}
```

---

## 🎨 UI/UXデザイン

### Step3Commands モード切り替えUI

```tsx
<Container>
  <Header>
    <SpaceBetween direction="horizontal" size="xs">
      <div>ステップ 3: スラッシュコマンド定義</div>
      <SegmentedControl
        selectedId={editorMode}
        onChange={({ detail }) => setEditorMode(detail.selectedId)}
        options={[
          { text: 'フォーム', id: 'form' },
          { text: 'ビジュアル', id: 'visual' }
        ]}
      />
    </SpaceBetween>
  </Header>

  {editorMode === 'form' ? (
    <FormEditor commands={commands} onChange={setCommands} />
  ) : (
    <BlocklyEditor commands={commands} onChange={setCommands} />
  )}
</Container>
```

### Step4Review ダウンロードボタン

```tsx
<SpaceBetween direction="horizontal" size="xs">
  <Button variant="primary" onClick={handleGitHubPush}>
    GitHubにpush
  </Button>
  <Button onClick={handleZipDownload} iconName="download">
    ZIPでダウンロード
  </Button>
</SpaceBetween>
```

---

## 🔄 データフロー

### フォーム ⇔ ビジュアル 変換

```
┌─────────────┐           ┌──────────────────┐
│ FormUI      │◄─────────►│ SlashCommand[]   │
│ (既存)      │  onChange │ (共通データ型)   │
└─────────────┘           └──────────────────┘
                                  ▲
                                  │
                                  │ converter
                                  │
                                  ▼
                          ┌──────────────────┐
                          │ Blockly XML      │
                          │ (ビジュアル表現) │
                          └──────────────────┘
                                  ▲
                                  │
                                  ▼
                          ┌──────────────────┐
                          │ BlocklyEditor    │
                          │ (ビジュアルUI)   │
                          └──────────────────┘
```

---

## ✅ 検証項目

### フェーズ1
- [ ] ZIPファイルが正しく生成される
- [ ] すべてのファイルがZIPに含まれる
- [ ] ダウンロードが正常に動作する
- [ ] ファイル名が適切（bot名+タイムスタンプ）

### フェーズ2
- [ ] Blocklyエディタが正常に表示される
- [ ] カスタムブロックが動作する
- [ ] フォーム→ビジュアル変換が正しい
- [ ] ビジュアル→フォーム変換が正しい
- [ ] モード切り替えでデータが保持される

### フェーズ3
- [ ] IF条件分岐が正しくコード生成される
- [ ] ループ処理が正しくコード生成される
- [ ] 複雑なロジックが動作する
- [ ] 生成されたBotコードが実行可能

---

## 📝 実装の優先順位

1. **最優先**: フェーズ1（ZIPダウンロード）
   - 理由: 既存機能の拡張のみ、すぐに価値を提供

2. **次**: フェーズ2（基本ビジュアルエディタ）
   - 理由: 基盤となる重要機能

3. **最後**: フェーズ3（高度機能）
   - 理由: 必須ではないが、差別化要素

---

## 🚀 次のステップ

計画承認後、以下の順序で実装:

1. **フェーズ1開始**: ZIPダウンロード機能
   - jszip, file-saver インストール
   - zip-generator.ts 作成
   - Step4Review修正
   - 動作確認

2. **フェーズ2開始**: Blocklyエディタ基盤
   - blockly インストール
   - カスタムブロック定義
   - 変換ロジック実装
   - Step3Commands修正

3. **フェーズ3開始**: 高度機能
   - 制御フローブロック追加
   - コード生成拡張
   - 統合テスト

---

## 📅 進捗管理

### 実装状況

| フェーズ | 状態 | 開始日 | 完了日 | 備考 |
|---------|------|--------|--------|------|
| フェーズ1 | 🔄 進行中 | 2025-11-08 | - | ZIPダウンロード機能 |
| フェーズ2 | ⏸️ 未着手 | - | - | Blocklyエディタ基盤 |
| フェーズ3 | ⏸️ 未着手 | - | - | 高度機能 |
